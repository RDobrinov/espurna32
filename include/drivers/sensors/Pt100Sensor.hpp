#ifndef INC_PT100SENSOR_HPP
#define INC_PT100SENSOR_HPP

#include "config/hardware.h"

#if RTD_SUPPORT && SPIBUS_SUPPORT

#include <Arduino.h>
#include "drivers/sensors/BaseSensor.hpp"
#include "drivers/sensors/SensorsConfig.hpp"

#ifndef PT100SENSOR_RPOLY_FN
#define PT100SENSOR_RPOLY_FN    1
#endif

#ifndef PT100SENSOR_TABLE_LUP
#define PT100SENSOR_TABLE_LUP   1
#endif

#ifndef PT100SENSOR_CUBIC_FIT
#define PT100SENSOR_CUBIC_FIT   1
#endif

#ifndef PT100SENSOR_VAN_DUSEN
#define PT100SENSOR_VAN_DUSEN   1
#endif

#ifndef PT100SENSOR_WIRES
#define PT100SENSOR_WIRES   4
#endif

#define MAX31865_CFG_REG    0x00        // Config register address
#define MAX31865_MRTD_REG   0x01        // RTD MSB register address
#define MAX31865_LRTD_REG   0x02        // RTD LSB register address
#define MAX31865_FAULT_REG  0x07        // Fault register address
#define MAX31865_WRITE_BIT  0b10000000

#define MAX31865_BIAS_BITS  0b10000000  
#define MAX31865_AUTO_BITS  0b01000000
#define MAX31865_BEG_1SHOT  0b00100000  // bit is auto cleared on complete
#define MAX31865_3WIRE_RTD  0b00010000
#define MAX31865_FAULT_CLR  0b00000010  // bit is auto cleared on complete
#define MAX31865_50HZ_NOTCH 0b00000001

#define MAX31865_FLT_HIRTD  0b10000000
#define MAX31865_FLT_LORTD  0b01000000
#define MAX31865_FLT_HREFIN 0b00100000
#define MAX31865_FLT_LREFIN 0b00010000
#define MAX31865_FLT_LRTDIN 0b00001000
#define MAX31865_FLT_OVERV  0b00000100

#define MAX31865_BIAS_DELAY 10          // 10.5 time constants of the input RC plus 1ms
#define MAX31865_MAX_TIME   65          // single conversion time

typedef struct 
{
    unsigned char raw[8];
    unsigned int adcValue;
    double rtdOhms;
    #if PT100SENSOR_RPOLY_FN
    double TRPolyFn;
    #endif
    #if PT100SENSOR_CUBIC_FIT
    double TCubicFit;
    #endif
    #if PT100SENSOR_TABLE_LUP
    double TableLU;
    #endif
    #if PT100SENSOR_VAN_DUSEN
    double TVanDusen;
    #endif
} rtdMAX31865_t;

class MAX31865Sensor : public BaseSensor
{
    public:
        MAX31865Sensor();

        bool measure();
        void calculate();

        void begin();
        void pre();
        String description();
        unsigned char type(unsigned char index);
        signed char decimals(unsigned char type);
        double value(unsigned char index);
        String address(unsigned char index);
        String slot(unsigned char index);

        unsigned char * getRaw();
        rtdMAX31865_t getState();

    private:
        void cfgRegisterCtrl(unsigned char regBits, bool set);
        void writeRegister(unsigned char reg, unsigned char value);
        void rawRead();
        void clearFault();
        void init();

        #if PT100SENSOR_RPOLY_FN
        void fnRPoly();
        #endif
        #if PT100SENSOR_CUBIC_FIT
        void fnCubicFit();
        #endif
        #if PT100SENSOR_VAN_DUSEN
        void fnVanDusen();
        #endif
        #if PT100SENSOR_TABLE_LUP
        void fnTableLookup();
        #endif

        rtdMAX31865_t state;
        bool _run_init = false;
};
#if PT100SENSOR_TABLE_LUP
// Pt100 callibration table

#define TBL_MIN_CELSIUS -200
#define TBL_MAX_CELSIUS 550

//#define MEASURED_R_REF  430
#define TABLE_R_REF     435


// Callibration table - ADC values at Rref = 430 ( by datasheet https://datasheets.maximintegrated.com/en/ds/MAX31865.pdf )
/*const static uint16_t adc_table[751] PROGMEM  = 
{
    1411,1444,1476,1509,1541,1574,1607,1640,1673,1705,
    1738,1770,1803,1835,1868,1900,1933,1966,1998,2032,
    2064,2097,2129,2162,2194,2227,2259,2291,2323,2355,
    2387,2419,2451,2483,2515,2547,2579,2611,2643,2675,
    2707,2739,2771,2803,2835,2867,2899,2931,2963,2995,
    3027,3059,3090,3122,3153,3184,3216,3247,3279,3311,
    3342,3374,3406,3436,3468,3500,3531,3563,3594,3626,
    3658,3688,3720,3752,3783,3815,3846,3877,3908,3940,
    3970,4001,4033,4063,4095,4126,4156,4188,4219,4250,
    4281,4312,4343,4374,4406,4436,4467,4499,4529,4561,
    4592,4622,4653,4684,4714,4745,4776,4807,4837,4868,
    4899,4929,4960,4992,5022,5053,5084,5114,5145,5176,
    5207,5237,5268,5299,5329,5360,5391,5420,5451,5482,
    5512,5542,5573,5603,5633,5664,5694,5725,5755,5786,
    5816,5847,5877,5907,5938,5968,5998,6029,6060,6089,
    6120,6150,6180,6210,6241,6271,6300,6331,6361,6392,
    6421,6451,6482,6512,6542,6572,6602,6633,6662,6693,
    6723,6753,6783,6813,6843,6873,6903,6933,6963,6993,
    7023,7053,7083,7113,7142,7173,7203,7233,7262,7292,
    7322,7352,7381,7411,7441,7472,7501,7531,7561,7591,
    7620,7650,7680,7710,7740,7769,7799,7829,7859,7888,
    7918,7948,7978,8007,8036,8066,8096,8126,8154,8184,
    8214,8244,8273,8302,8332,8362,8392,8421,8450,8480,
    8510,8540,8568,8598,8628,8658,8687,8716,8746,8775,
    8805,8834,8863,8893,8922,8952,8981,9010,9040,9069,
    9099,9128,9157,9187,9216,9246,9274,9304,9333,9363,
    9392,9420,9450,9479,9509,9538,9567,9596,9625,9655,
    9684,9713,9742,9771,9800,9830,9859,9887,9916,9946,
    9975,10004,10033,10062,10091,10120,10149,10178,10207,10236,
    10265,10294,10323,10352,10380,10410,10439,10468,10497,10526,
    10554,10583,10612,10641,10670,10700,10728,10757,10786,10815,
    10844,10873,10901,10930,10959,10988,11016,11045,11073,11102,
    11131,11160,11189,11217,11246,11274,11303,11332,11360,11389,
    11418,11447,11475,11503,11532,11561,11590,11619,11647,11675,
    11704,11733,11761,11790,11818,11847,11875,11903,11932,11960,
    11989,12018,12046,12074,12102,12131,12160,12188,12217,12245,
    12273,12301,12330,12358,12387,12415,12443,12472,12500,12528,
    12556,12584,12613,12641,12670,12698,12726,12754,12782,12811,
    12839,12867,12895,12924,12952,12980,13007,13035,13064,13092,
    13120,13148,13176,13205,13233,13260,13288,13316,13345,13373,
    13401,13429,13457,13485,13513,13540,13568,13596,13624,13652,
    13680,13708,13736,13764,13792,13820,13847,13875,13903,13931,
    13959,13987,14015,14043,14071,14099,14127,14154,14181,14209,
    14237,14265,14293,14320,14348,14376,14404,14432,14459,14487,
    14514,14542,14570,14597,14625,14653,14681,14709,14736,14764,
    14792,14820,14847,14874,14901,14929,14956,14984,15011,15039,
    15066,15094,15121,15149,15176,15204,15231,15259,15286,15313,
    15340,15368,15395,15423,15450,15478,15505,15533,15560,15587,
    15614,15642,15669,15696,15724,15751,15778,15805,15833,15860,
    15887,15913,15941,15968,15995,16023,16050,16077,16104,16132,
    16159,16186,16213,16240,16267,16294,16321,16349,16376,16403,
    16430,16457,16484,16511,16538,16565,16592,16619,16646,16673,
    16700,16727,16754,16781,16808,16835,16862,16889,16915,16942,
    16969,16996,17023,17049,17076,17103,17130,17157,17183,17210,
    17237,17264,17291,17317,17344,17371,17398,17425,17451,17478,
    17505,17532,17558,17585,17611,17638,17665,17691,17718,17744,
    17771,17798,17824,17851,17877,17904,17931,17957,17984,18010,
    18037,18064,18090,18117,18143,18170,18196,18223,18249,18275,
    18302,18328,18355,18381,18407,18434,18460,18487,18513,18540,
    18566,18593,18619,18645,18672,18698,18725,18751,18777,18804,
    18830,18856,18882,18908,18934,18961,18987,19013,19039,19065,
    19091,19117,19143,19170,19196,19222,19248,19274,19300,19327,
    19353,19380,19406,19432,19458,19484,19510,19536,19562,19588,
    19613,19639,19665,19691,19717,19743,19769,19795,19820,19847,
    19873,19899,19925,19951,19977,20003,20028,20054,20080,20106,
    20132,20158,20183,20209,20235,20260,20287,20312,20338,20364,
    20389,20415,20441,20466,20492,20518,20543,20569,20595,20620,
    20647,20672,20698,20724,20749,20775,20800,20826,20851,20877,
    20902,20927,20953,20979,21005,21030,21055,21081,21106,21132,
    21157,21182,21208,21233,21260,21285,21310,21336,21361,21387,
    21412,21437,21462,21487,21513,21539,21564,21589,21614,21639,
    21665,21690,21715,21740,21766,21791,21817,21842,21867,21892,
    21917,21942,21968,21993,22019,22044,22069,22094,22119,22144,
    22169,22194,22219,22244,22269,22294,22319,22344,22369,22394,
    22420,22445,22470,22495,22519,22544,22569,22594,22620,22645,
    22670
};
*/
// Callibration table - ADC values at Rref = 435 ( measured )
const static unsigned int adc_table[751] PROGMEM  = 
{ 1395,1427,1459,1491,1524,1556,1588,1621,1653,1686,
  1718,1750,1782,1814,1846,1879,1911,1943,1975,2008,
  2040,2073,2105,2137,2169,2201,2233,2265,2296,2328,
  2360,2391,2423,2454,2486,2518,2549,2581,2612,2645,
  2676,2707,2739,2771,2803,2834,2865,2897,2929,2961,
  2992,3023,3055,3086,3117,3148,3179,3210,3241,3273,
  3304,3335,3366,3397,3428,3459,3491,3522,3553,3584,
  3616,3646,3677,3709,3740,3771,3801,3833,3863,3894,
  3925,3955,3986,4017,4048,4078,4109,4140,4170,4201,
  4232,4262,4293,4324,4355,4385,4416,4447,4477,4509,
  4539,4569,4600,4630,4660,4691,4721,4751,4782,4812,
  4842,4873,4903,4934,4965,4995,5025,5056,5086,5116,
  5147,5177,5207,5238,5268,5298,5329,5358,5389,5419,
  5448,5479,5509,5538,5569,5599,5629,5659,5689,5720,
  5749,5779,5810,5839,5869,5900,5929,5960,5990,6019,
  6050,6079,6109,6139,6169,6199,6228,6258,6288,6318,
  6348,6377,6407,6437,6467,6497,6526,6556,6586,6616,
  6646,6675,6705,6735,6764,6794,6824,6853,6883,6913,
  6943,6972,7001,7031,7060,7091,7120,7149,7179,7208,
  7238,7267,7297,7326,7355,7386,7415,7445,7474,7503,
  7533,7562,7592,7621,7651,7680,7709,7739,7768,7798,
  7827,7857,7886,7914,7944,7973,8003,8032,8061,8090,
  8120,8149,8178,8207,8236,8266,8295,8325,8353,8383,
  8412,8441,8470,8499,8529,8558,8587,8616,8646,8674,
  8703,8733,8761,8791,8819,8849,8878,8907,8936,8965,
  8994,9023,9052,9081,9110,9139,9168,9197,9226,9255,
  9284,9312,9342,9370,9400,9428,9457,9486,9514,9544,
  9572,9601,9630,9659,9687,9717,9745,9774,9802,9832,
  9860,9889,9917,9947,9975,10004,10032,10061,10090,10119,
  10147,10176,10204,10233,10261,10291,10319,10348,10376,10405,
  10433,10462,10490,10519,10547,10577,10605,10634,10662,10691,
  10719,10748,10776,10805,10833,10862,10889,10918,10946,10975,
  11003,11032,11060,11088,11116,11145,11173,11202,11229,11258,
  11286,11315,11343,11371,11400,11428,11457,11485,11513,11541,
  11570,11598,11626,11654,11682,11710,11739,11766,11795,11823,
  11851,11880,11907,11936,11963,11992,12020,12048,12076,12104,
  12132,12160,12189,12216,12245,12272,12300,12328,12356,12384,
  12412,12440,12468,12496,12524,12552,12579,12608,12635,12664,
  12691,12719,12747,12775,12803,12830,12858,12886,12914,12942,
  12969,12997,13024,13053,13080,13108,13136,13163,13192,13219,
  13247,13274,13302,13330,13357,13385,13412,13440,13468,13495,
  13523,13550,13578,13606,13633,13661,13688,13716,13743,13771,
  13799,13826,13854,13881,13909,13937,13964,13992,14018,14046,
  14074,14101,14129,14155,14183,14211,14238,14266,14292,14320,
  14348,14375,14403,14429,14457,14485,14512,14540,14566,14594,
  14622,14649,14676,14703,14730,14758,14784,14812,14839,14866,
  14893,14920,14947,14975,15001,15029,15056,15083,15110,15137,
  15164,15192,15218,15246,15273,15300,15327,15354,15381,15408,
  15434,15462,15489,15515,15543,15570,15596,15623,15651,15677,
  15704,15731,15758,15785,15811,15839,15866,15892,15919,15947,
  15973,16000,16027,16053,16080,16107,16133,16161,16188,16214,
  16241,16268,16294,16321,16348,16374,16401,16428,16454,16482,
  16509,16535,16562,16589,16615,16642,16669,16695,16721,16748,
  16774,16801,16828,16853,16880,16907,16933,16960,16986,17012,
  17039,17066,17092,17118,17145,17171,17198,17225,17251,17277,
  17304,17331,17356,17383,17409,17435,17462,17488,17514,17540,
  17567,17594,17619,17646,17672,17698,17725,17751,17777,17803,
  17830,17857,17882,17909,17935,17961,17987,18014,18040,18065,
  18092,18118,18144,18170,18196,18223,18248,18274,18301,18326,
  18352,18379,18405,18430,18457,18483,18509,18535,18561,18588,
  18613,18639,18665,18691,18716,18743,18769,18794,18820,18846,
  18872,18897,18923,18950,18976,19001,19027,19053,19079,19104,
  19130,19157,19183,19208,19234,19260,19286,19311,19337,19363,
  19388,19413,19439,19465,19491,19516,19542,19568,19593,19618,
  19644,19670,19696,19721,19747,19773,19798,19823,19849,19875,
  19901,19926,19951,19977,20003,20028,20053,20078,20104,20130,
  20154,20180,20206,20231,20257,20282,20307,20333,20359,20383,
  20409,20434,20460,20486,20510,20536,20561,20587,20611,20637,
  20662,20687,20713,20737,20763,20788,20813,20839,20863,20889,
  20914,20939,20965,20989,21015,21040,21065,21091,21115,21141,
  21166,21191,21216,21240,21266,21291,21316,21341,21366,21390,
  21416,21441,21466,21491,21515,21540,21566,21591,21616,21640,
  21665,21690,21716,21741,21766,21790,21815,21840,21865,21890,
  21914,21939,21963,21988,22013,22038,22063,22087,22112,22137,
  22162,22187,22211,22236,22260,22285,22310,22335,22360,22384,
  22409 };

#endif
#endif /* RTD_SUPPORT && SPIBUS_SUPPORT */
#endif /* INC_PT100SENSOR_HPP */